---
title: "Test MEDGICARB data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Test MEDGICARB data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
library(CoolBeans)
library(tidyverse)
library(tidymodels)
library(missRanger)
library(missForest)
library(recipes)
library(glmnet)
library(rsample)
library(caret)
devtools::load_all()
```

Load clustered data, a regression model will be implemented:

```{r load raw data 1}
fpath <- system.file("extdata", "MEDGICARB_peaktable_clustered.rds", package = "CoolBeans")
raw_data <- readRDS(fpath)

raw_data_boxplots <- raw_data[, c(14:23)] %>%
  tidyr::gather(key = "HN", value = "value", starts_with("HN"))

boxplot <- raw_data_boxplots %>%
  ggplot2::ggplot(aes(x = HN, y = value)) +
  ggplot2::geom_boxplot() +
  labs(x = "Metabolites", y = "Intensity") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

boxplot
```

Data preprocessing:

```{r preprocessing 1}
prep_data <- preprocessing(raw_data, start_metabolites = 14, "combo", "BMI")
prep_data_boxplots <- prep_data[, c(14:23)] %>%
  tidyr::gather(key = "HNC", value = "value", starts_with("HNC"))

boxplot_prep <- prep_data_boxplots %>%
  ggplot2::ggplot(aes(x = HNC, y = value)) +
  ggplot2::geom_boxplot() +
  ggplot2::labs(x = "Metabolites", y = "Intensity") +
  ggplot2::theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

boxplot_prep
```

Split data into training and testing datasets. NaN are also removed from
the target column.

```{r splitting data 1}

selected_data <- prep_data[,c(12:ncol(prep_data))] #select data for regression

data_split <- splitting(selected_data)
train_data <- data_split$train_data
test_data <- data_split$test_data
# check NA
which(is.na(train_data$target))
which(is.na(test_data$target))
# remove rows that have NA in target/label column
train_data <- train_data %>% drop_na("target")
test_data <- test_data %>% drop_na("target")
```

Trained model, for regression select 1 and for classification select 2:

```{r train 1}
trained_model <- training_rf(train_data, type = 1)
trained_model
```

Testing model and results:

```{r results 1}
results <- testing_rf_regression(trained_model, test_data)
results
```

Load clustered data, a classification model will be implemented:

Data preprocessing:

```{r preprocessing 2}
prep_data <- preprocessing(raw_data, start_metabolites = 14, "combo", "group")
prep_data_boxplots <- prep_data[, c(14:23)] %>%
  tidyr::gather(key = "HNC", value = "value", starts_with("HNC"))

boxplot_prep <- prep_data_boxplots %>%
  ggplot2::ggplot(aes(x = HNC, y = value)) +
  ggplot2::geom_boxplot() +
  ggplot2::labs(x = "Metabolites", y = "Intensity") +
  ggplot2::theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

boxplot_prep
```

Split data into training and testing datasets. NaN are also removed from
the diet_score column.

```{r splitting 2}
selected_data <- prep_data[,c(12:ncol(prep_data))] #select data for regression

data_split <- splitting(selected_data)
train_data <- data_split$train_data
test_data <- data_split$test_data
# check NA
which(is.na(train_data$target))
which(is.na(test_data$target))
# remove rows that have NA in target/label column
train_data <- train_data %>% drop_na("target")
test_data <- test_data %>% drop_na("target")
```

Trained model, for regression select 1 and for classification select 2:

```{r train 2}
trained_model <- training_rf(train_data, type = 2)
trained_model
```

Testing model and results:

```{r test 2}
results <- testing_rf_classification(trained_model, test_data)
results
```
